### インフラのセットアップ

```bash
cd ops/03_production
vagrant up
vagrant ssh
```

```bash
cd /vagrant
./src/build/sh/build.sh
source ~/.bash_profile
exit
vagrant reload
```

```bash
cd /vagrant/build
sudo chef-client -z -j provision.json
```

#### IAMセットアップ

```bash
cd /vagrant/src/build/aws/iam/
aws cloudformation validate-template --template-body file://$PRD_IAM_TEMPLATE
chmod 0755 ./create_stack.sh
./create_stack.sh
aws cloudformation list-stack-resources --stack-name $PRD_IAM_STACKNAME --output table
```

#### S3バケットの作成
```bash
$ aws s3 mb s3://$PRD_S3_BACKET
```

#### レポジトリ用秘密鍵と公開鍵の作成
```
cd /vagrant/config/secure/
ssh-keygen -f $PRD_APP_REPOSITORY_SSH_KEY
cp /vagrant/config/secure/$PRD_APP_REPOSITORY_SSH_KEY ~/.ssh/
cp /vagrant/config/secure/$PRD_APP_REPOSITORY_SSH_KEY.pub ~/.ssh/
chmod 0400 ~/.ssh/$PRD_APP_REPOSITORY_SSH_KEY
chmod 0400 ~/.ssh/$PRD_APP_REPOSITORY_SSH_KEY.pub

ssh-keygen -f $PRD_APP_JOB_REPOSITORY_SSH_KEY
cp /vagrant/config/secure/$PRD_APP_JOB_REPOSITORY_SSH_KEY ~/.ssh/
cp /vagrant/config/secure/$PRD_APP_JOB_REPOSITORY_SSH_KEY.pub ~/.ssh/
chmod 0400 ~/.ssh/$PRD_APP_JOB_REPOSITORY_SSH_KEY
chmod 0400 ~/.ssh/$PRD_APP_JOB_REPOSITORY_SSH_KEY.pub

ssh-keygen -f $PRD_APP_API_REPOSITORY_SSH_KEY
cp /vagrant/config/secure/$PRD_APP_API_REPOSITORY_SSH_KEY ~/.ssh/
cp /vagrant/config/secure/$PRD_APP_API_REPOSITORY_SSH_KEY.pub ~/.ssh/
chmod 0400 ~/.ssh/$PRD_APP_API_REPOSITORY_SSH_KEY
chmod 0400 ~/.ssh/$PRD_APP_API_REPOSITORY_SSH_KEY.pub

ssh-keygen -f $PRD_APP_BOT_REPOSITORY_SSH_KEY
cp /vagrant/config/secure/$PRD_APP_BOT_REPOSITORY_SSH_KEY ~/.ssh/
cp /vagrant/config/secure/$PRD_APP_BOT_REPOSITORY_SSH_KEY.pub ~/.ssh/
chmod 0400 ~/.ssh/$PRD_APP_BOT_REPOSITORY_SSH_KEY
chmod 0400 ~/.ssh/$PRD_APP_BOT_REPOSITORY_SSH_KEY.pub

chmod 700 ~/.ssh/config
```

#### 証明書を作成する
+ Route53でドメインを取得視する
+ [証明書のリクエスト](https://docs.aws.amazon.com/ja_jp/acm/latest/userguide/gs-acm-request.html)

#### EC2キーペアの作成
```bash
cd /vagrant/config/secure/
../../src/build/aws/ec2/create_key_pare.sh
```
再作成をする場合は以下のコマンドで秘密鍵を削除してからコピーする
```bash
rm  ~/.ssh/$PRD_SSH_KEY
cp $PRD_SSH_KEY  ~/.ssh/
chmod 0400 ~/.ssh/$PRD_SSH_KEY
```

#### VPCの作成
```bash
cd /vagrant/src/build/aws/vpc/
aws cloudformation validate-template --template-body file://$PRD_VPC_TEMPLATE
chmod 0755 ./create_stack.sh
./create_stack.sh
aws cloudformation list-stack-resources --stack-name $PRD_VPC_STACKNAME --output table
```
